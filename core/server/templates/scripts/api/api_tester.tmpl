{{define "api_tester_js"}}
    // =============================================================================
    // API TESTER - REFACTORED COORDINATOR
    // =============================================================================

    const APITester = {
        currentEndpoint: null,
        parameterSchema: null,
        initialized: false,

        // Initialize the API tester
        init() {
            if (this.initialized) {
                return;
            }
            this.bindEvents();
            this.initialized = true;
        },



        // Bind event listeners
        bindEvents() {
            // Remove existing event listeners to prevent duplicates
            document.removeEventListener('apiTesterSidebarOpened', this.handleSidebarOpened);
            document.removeEventListener('apiTesterSidebarClosed', this.handleSidebarClosed);
            document.removeEventListener('apiTesterTabChange', this.handleTabChange);

            // Create bound methods for proper removal later
            this.boundHandleSidebarOpened = (e) => this.handleSidebarOpened(e.detail);
            this.boundHandleSidebarClosed = () => this.handleSidebarClosed();
            this.boundHandleTabChange = (e) => this.handleTabChange(e.detail);

            // Listen for sidebar events
            document.addEventListener('apiTesterSidebarOpened', this.boundHandleSidebarOpened);
            document.addEventListener('apiTesterSidebarClosed', this.boundHandleSidebarClosed);
            document.addEventListener('apiTesterTabChange', this.boundHandleTabChange);

            // Form action buttons
            const sendBtn = document.getElementById('send-request-btn');
            const resetBtn = document.getElementById('reset-form-btn');

            if (sendBtn) {
                sendBtn.addEventListener('click', () => this.sendRequest());
            }

            if (resetBtn) {
                resetBtn.addEventListener('click', () => this.resetForm());
            }
        },

        // Handle sidebar opened event
        handleSidebarOpened(detail) {
            // Prevent duplicate processing
            if (this.currentEndpoint &&
                this.currentEndpoint.method === detail.method &&
                this.currentEndpoint.path === detail.path) {
                return;
            }

            this.currentEndpoint = detail;

            // Process the endpoint to generate form
            this.processEndpointSchema();
        },

        // Handle sidebar closed event
        handleSidebarClosed() {
            this.currentEndpoint = null;
            this.parameterSchema = null;
        },

        // Handle tab change event
        handleTabChange(detail) {
            if (detail.tab === 'response') {
                this.refreshResponseDisplay();
            }
        },

        // Process endpoint schema and generate form
        processEndpointSchema() {
            const container = document.getElementById('schema-form-container');
            if (!container) {
                console.error('Schema form container not found');
                return;
            }

            try {
                // Show loading state
                this.showLoadingState(container);

                // Extract parameter schema from endpoint data using APISchemaManager
                this.parameterSchema = APISchemaManager.extractParameterSchema(this.currentEndpoint);

                // Generate form using APIFormBuilder
                APIFormBuilder.generateParameterForm(container, this.parameterSchema, this.currentEndpoint);

                // Populate default values using APIExampleGenerator
                APIExampleGenerator.populateDefaultValues(this.parameterSchema);

            } catch (error) {
                console.error('Schema processing error:', error);
                this.showError(container, error);
            }
        },

        // Show loading state
        showLoadingState(container) {
            container.innerHTML = `
                <div class="txt-center txt-hint p-4">
                    <i class="ri-loader-4-line animate-spin"></i>
                    <p>Processing endpoint schema...</p>
                </div>
            `;
        },

        // Show error state
        showError(container, error) {
            container.innerHTML = `
                <div class="txt-center p-4">
                    <div class="alert alert-danger">
                        <i class="ri-error-warning-line"></i>
                        <p><strong>Schema Processing Failed:</strong></p>
                        <p>${error.message}</p>
                    </div>
                    <details>
                        <summary>Debug Information</summary>
                        <pre class="txt-xs mt-2">${JSON.stringify({
                            currentEndpoint: this.currentEndpoint,
                            error: error.toString(),
                            stack: error.stack
                        }, null, 2)}</pre>
                    </details>
                </div>
            `;
        },

        // Send HTTP request using APIRequestHandler
        async sendRequest() {
            if (!this.currentEndpoint) {
                console.error('No current endpoint for request');
                return;
            }

            try {
                await APIRequestHandler.sendRequest(this.currentEndpoint);
            } catch (error) {
                // Error handling is done by APIRequestHandler
            }
        },

        // Reset form using APIRequestHandler
        resetForm() {
            APIRequestHandler.resetForm();

            // Re-process the endpoint schema to regenerate clean form
            this.processEndpointSchema();
        },

        // Refresh response display when switching to response tab
        refreshResponseDisplay() {
            // Check if we have response content to display
            const emptyState = document.getElementById('response-empty-state');
            const hasContent = emptyState && emptyState.style.display === 'none';

            // Content display is handled by UI state
        },

        // Public API for opening sidebar (for endpoint renderer integration)
        openSidebar(method, path, endpointData) {
            if (typeof APITesterSidebar !== 'undefined') {
                APITesterSidebar.openSidebar(method, path, endpointData);
            } else {
                console.warn('APITesterSidebar not available');
            }
        },

        // Switch to raw JSON input mode (public API for form builder)
        useRawJSON() {
            APIFormBuilder.switchToRawJSON();
        },

        // Generate example for current endpoint (public API)
        generateExample() {
            if (!this.parameterSchema || !this.currentEndpoint) {
                console.warn('Cannot generate example: missing schema or endpoint');
                return null;
            }

            return APIExampleGenerator.generateCompleteExample(this.parameterSchema, this.currentEndpoint);
        },

        // Get current endpoint info (public API)
        getCurrentEndpoint() {
            return this.currentEndpoint;
        },

        // Get current parameter schema (public API)
        getParameterSchema() {
            return this.parameterSchema;
        },

        // Check if endpoint requires authentication (utility method)
        requiresAuth() {
            if (!this.currentEndpoint || !this.currentEndpoint.data) return false;

            // Check if endpoint has security requirements
            return this.currentEndpoint.data.security && this.currentEndpoint.data.security.length > 0;
        },

        // Get endpoint summary information (utility method)
        getEndpointSummary() {
            if (!this.currentEndpoint) return null;

            return {
                method: this.currentEndpoint.method,
                path: this.currentEndpoint.path,
                summary: this.currentEndpoint.data?.summary || 'No summary available',
                description: this.currentEndpoint.data?.description || '',
                tags: this.currentEndpoint.data?.tags || [],
                requiresAuth: this.requiresAuth()
            };
        }
    };
{{end}}
