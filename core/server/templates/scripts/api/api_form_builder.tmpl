{{define "api_form_builder_js"}}
    // =============================================================================
    // API FORM BUILDER - SIMPLIFIED FOR AST-BASED SCHEMAS
    // =============================================================================

    const APIFormBuilder = {

        // Generate parameter form from endpoint schema
        generateParameterForm(container, endpoint) {
            if (!container || !endpoint) {
                console.error('Invalid container or endpoint for form generation');
                return;
            }

            container.innerHTML = '';
            const sections = [];

            // Build path parameters section
            const pathParams = APISchemaManager.extractPathParameters(endpoint.path);
            if (pathParams.length > 0) {
                sections.push(this.buildPathParametersSection(pathParams));
            }

            // Build request body section from AST schema
            const requestFields = APISchemaManager.extractRequestFields(endpoint);
            if (requestFields.length > 0) {
                sections.push(this.buildRequestBodySection(requestFields));
            }

            // Build manual query parameters section (always available)
            sections.push(this.buildManualQuerySection());

            // Add all sections to container
            sections.forEach(section => {
                if (section) {
                    container.appendChild(section);
                }
            });

            // If no sections, show helpful message
            if (sections.length === 0) {
                container.innerHTML = `
                    <div class="card card-body">
                        <div class="txt-center txt-hint p-4">
                            <i class="ri-information-line"></i>
                            <p>This endpoint doesn't require any parameters.</p>
                        </div>
                    </div>
                `;
            }
        },

        // Build path parameters section
        buildPathParametersSection(pathParams) {
            const section = document.createElement('div');
            section.className = 'card card-body m-b-sm';
            section.innerHTML = `
                <div class="form-section">
                    <h6 class="form-section-title">
                        <i class="ri-route-line"></i>
                        Path Parameters
                    </h6>
                    <p class="txt-hint txt-xs m-b-sm">These parameters are part of the URL path and are required.</p>
                    <div class="path-parameters">
                        ${pathParams.map(param => this.buildParameterField(param, 'path')).join('')}
                    </div>
                </div>
            `;
            return section;
        },

        // Build request body section from AST schema
        buildRequestBodySection(requestFields) {
            const section = document.createElement('div');
            section.className = 'card card-body m-b-sm';

            const requiredFields = requestFields.filter(field => field.required);
            const optionalFields = requestFields.filter(field => !field.required);

            section.innerHTML = `
                <div class="form-section">
                    <h6 class="form-section-title">
                        <i class="ri-file-text-line"></i>
                        Request Body
                        <span class="txt-xs txt-hint">(application/json)</span>
                    </h6>
                    <p class="txt-hint txt-xs m-b-sm">Data to be sent in the request body.</p>

                    ${requiredFields.length > 0 ? `
                        <div class="required-fields">
                            <h7 class="txt-sm txt-bold">Required Fields</h7>
                            ${requiredFields.map(field => this.buildRequestField(field)).join('')}
                        </div>
                    ` : ''}

                    ${optionalFields.length > 0 ? `
                        <div class="optional-fields ${requiredFields.length > 0 ? 'm-t-sm' : ''}">
                            <h7 class="txt-sm txt-bold">Optional Fields</h7>
                            ${optionalFields.map(field => this.buildRequestField(field)).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            return section;
        },

        // Build manual query parameters section
        buildManualQuerySection() {
            const section = document.createElement('div');
            section.className = 'card card-body m-b-sm';
            section.innerHTML = `
                <div class="form-section">
                    <h6 class="form-section-title">
                        <i class="ri-search-line"></i>
                        Query Parameters
                        <span class="txt-xs txt-hint">(optional)</span>
                    </h6>
                    <p class="txt-hint txt-xs m-b-sm">Add custom query parameters to the URL.</p>
                    <div class="query-parameters">
                        <div class="query-param-row">
                            <input type="text" class="form-field query-param-name" placeholder="Parameter name">
                            <input type="text" class="form-field query-param-value" placeholder="Parameter value">
                            <button type="button" class="btn btn-sm btn-secondary btn-outline add-query-param">
                                <i class="ri-add-line"></i>
                            </button>
                        </div>
                        <div class="added-query-params"></div>
                    </div>
                </div>
            `;

            // Add event listener for adding query parameters
            const addBtn = section.querySelector('.add-query-param');
            addBtn.addEventListener('click', () => this.addQueryParameter(section));

            return section;
        },

        // Build parameter field (for path parameters)
        buildParameterField(param, source) {
            const fieldId = `param-${source}-${param.name}`;

            return `
                <div class="form-field-group m-b-xs">
                    <label for="${fieldId}" class="form-label">
                        ${param.name}
                        ${param.required ? '<span class="txt-danger">*</span>' : ''}
                    </label>
                    <input
                        type="text"
                        id="${fieldId}"
                        name="${param.name}"
                        class="form-field"
                        data-source="${source}"
                        ${param.required ? 'required' : ''}
                        placeholder="${param.description || `Enter ${param.name}`}"
                    >
                    ${param.description ? `<div class="form-field-help">${param.description}</div>` : ''}
                </div>
            `;
        },

        // Build request body field
        buildRequestField(field) {
            const fieldId = `body-${field.name}`;
            const inputType = this.getInputType(field);

            return `
                <div class="form-field-group m-b-xs">
                    <label for="${fieldId}" class="form-label">
                        ${field.name}
                        ${field.required ? '<span class="txt-danger">*</span>' : ''}
                        <span class="txt-xs txt-hint">(${field.type})</span>
                    </label>
                    ${this.buildFieldInput(field, fieldId, inputType)}
                    ${field.description ? `<div class="form-field-help">${field.description}</div>` : ''}
                </div>
            `;
        },

        // Get appropriate input type for field
        getInputType(field) {
            switch (field.type) {
                case 'checkbox':
                    return 'checkbox';
                case 'textarea':
                    return 'textarea';
                case 'number':
                    return 'number';
                default:
                    return 'text';
            }
        },

        // Build field input HTML
        buildFieldInput(field, fieldId, inputType) {
            const commonAttrs = `
                id="${fieldId}"
                name="${field.name}"
                class="form-field"
                data-type="${field.type}"
                ${field.required ? 'required' : ''}
                ${field.pattern ? `pattern="${field.pattern}"` : ''}
                ${field.minimum !== undefined ? `min="${field.minimum}"` : ''}
                ${field.maximum !== undefined ? `max="${field.maximum}"` : ''}
            `;

            switch (inputType) {
                case 'checkbox':
                    return `
                        <div class="form-field-toggle">
                            <input type="checkbox" ${commonAttrs} ${field.example === true ? 'checked' : ''}>
                            <label for="${fieldId}">Enable ${field.name}</label>
                        </div>
                    `;

                case 'textarea':
                    return `
                        <textarea ${commonAttrs} rows="3" placeholder="${field.example || `Enter ${field.name}`}">${field.example && typeof field.example === 'object' ? JSON.stringify(field.example, null, 2) : (field.example || '')}</textarea>
                    `;

                case 'number':
                    return `
                        <input type="number" ${commonAttrs} placeholder="${field.example || `Enter ${field.name}`}" value="${field.example || ''}">
                    `;

                default:
                    if (field.enum) {
                        return `
                            <select ${commonAttrs}>
                                <option value="">Select ${field.name}</option>
                                ${field.enum.map(value => `
                                    <option value="${value}" ${field.example === value ? 'selected' : ''}>${value}</option>
                                `).join('')}
                            </select>
                        `;
                    }

                    return `
                        <input type="text" ${commonAttrs} placeholder="${field.example || `Enter ${field.name}`}" value="${field.example || ''}">
                    `;
            }
        },

        // Add query parameter row
        addQueryParameter(section) {
            const nameInput = section.querySelector('.query-param-name');
            const valueInput = section.querySelector('.query-param-value');
            const container = section.querySelector('.added-query-params');

            const name = nameInput.value.trim();
            const value = valueInput.value.trim();

            if (!name) {
                nameInput.focus();
                return;
            }

            // Create parameter row
            const paramRow = document.createElement('div');
            paramRow.className = 'query-param-added flex-fill m-b-xs';
            paramRow.innerHTML = `
                <div class="flex-fill">
                    <input type="text" class="form-field" name="query-${name}" value="${value}" placeholder="Value for ${name}" readonly>
                    <div class="form-field-help">${name}</div>
                </div>
                <button type="button" class="btn btn-sm btn-secondary btn-outline remove-query-param">
                    <i class="ri-close-line"></i>
                </button>
            `;

            // Add remove functionality
            paramRow.querySelector('.remove-query-param').addEventListener('click', () => {
                paramRow.remove();
            });

            container.appendChild(paramRow);

            // Clear inputs
            nameInput.value = '';
            valueInput.value = '';
            nameInput.focus();
        },

        // Collect all form data
        collectFormData() {
            const formData = {
                pathParameters: {},
                queryParameters: {},
                requestBody: {}
            };

            // Collect path parameters
            document.querySelectorAll('[data-source="path"]').forEach(input => {
                if (input.value.trim()) {
                    formData.pathParameters[input.name] = input.value.trim();
                }
            });

            // Collect query parameters
            document.querySelectorAll('[name^="query-"]').forEach(input => {
                const paramName = input.name.replace('query-', '');
                if (input.value.trim()) {
                    formData.queryParameters[paramName] = input.value.trim();
                }
            });

            // Collect request body fields
            document.querySelectorAll('[data-type]').forEach(input => {
                const fieldType = input.getAttribute('data-type');
                let value;

                switch (fieldType) {
                    case 'boolean':
                        value = input.type === 'checkbox' ? input.checked : (input.value === 'true');
                        break;
                    case 'integer':
                        value = input.value ? parseInt(input.value, 10) : null;
                        break;
                    case 'number':
                        value = input.value ? parseFloat(input.value) : null;
                        break;
                    case 'object':
                        try {
                            value = input.value ? JSON.parse(input.value) : null;
                        } catch (e) {
                            value = input.value;
                        }
                        break;
                    default:
                        value = input.value || null;
                }

                if (value !== null && value !== '') {
                    formData.requestBody[input.name] = value;
                }
            });

            return formData;
        },

        // Validate form data
        validateForm(endpoint) {
            const formData = this.collectFormData();
            const errors = [];

            // Validate path parameters
            const pathParams = APISchemaManager.extractPathParameters(endpoint.path);
            pathParams.forEach(param => {
                if (param.required && !formData.pathParameters[param.name]) {
                    errors.push(`Path parameter '${param.name}' is required`);
                }
            });

            // Validate request body
            if (endpoint.request) {
                const validation = APISchemaManager.validateRequestData(endpoint, formData.requestBody);
                errors.push(...validation.errors);
            }

            return {
                valid: errors.length === 0,
                errors: errors,
                data: formData
            };
        },

        // Clear all form fields
        clearForm() {
            document.querySelectorAll('.form-field').forEach(field => {
                if (field.type === 'checkbox') {
                    field.checked = false;
                } else {
                    field.value = '';
                }
            });

            // Remove added query parameters
            document.querySelectorAll('.query-param-added').forEach(param => {
                param.remove();
            });
        }
    };
{{end}}
