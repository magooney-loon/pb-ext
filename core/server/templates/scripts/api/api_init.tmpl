{{define "api_init_js"}}
    // =============================================================================
    // API SYSTEM INITIALIZATION - STREAMLINED
    // =============================================================================

    // Global initialization guard
    if (window.apiSystemInitialized) {
        return;
    }

    // System initialization
    async function initializeApp() {
        try {
            console.log('üöÄ Starting API System Initialization...');

            // Initialize core system (EventBus, StateManager, ErrorManager)
            console.log('üì¶ Initializing Core System...');
            await APICore.init();
            console.log('‚úÖ Core System initialized');

            // Wait for required modules to be available
            console.log('‚è≥ Waiting for required modules...');
            await waitForModules(['APIDataManager', 'APIUIManager', 'APITestingManager']);
            console.log('‚úÖ All required modules available');

            // Initialize data management
            if (typeof APIDataManager !== 'undefined') {
                console.log('üìä Initializing Data Manager...');
                await APIDataManager.init();
                console.log('‚úÖ Data Manager initialized');
            } else {
                console.error('‚ùå APIDataManager not found');
            }

            // Initialize UI management
            if (typeof APIUIManager !== 'undefined') {
                console.log('üé® Initializing UI Manager...');
                APIUIManager.init();
                console.log('‚úÖ UI Manager initialized');
            } else {
                console.error('‚ùå APIUIManager not found');
            }

            // Initialize testing system
            if (typeof APITestingManager !== 'undefined') {
                console.log('üß™ Initializing Testing Manager...');
                APITestingManager.init();
                console.log('‚úÖ Testing Manager initialized');
            } else {
                console.error('‚ùå APITestingManager not found');
            }

            // Load initial data
            if (typeof APIDataManager !== 'undefined') {
                console.log('üì° Loading API versions and data...');
                await APIDataManager.loadVersions();
                console.log('‚úÖ API data loaded');
            } else {
                console.error('‚ùå Cannot load data - APIDataManager not available');
            }

            // Mark system as initialized
            window.apiSystemInitialized = true;
            StateManager.setState('system.initialized', true);

            // Final setup
            console.log('üéØ Setting up final UI...');
            setupFinalUI();
            console.log('‚úÖ Final UI setup complete');

            ErrorManager.updateStatus('success', 'System ready');
            console.log('üéâ API System fully initialized and ready!');

            // Debug info
            console.log('üîç System State:', {
                endpoints: StateManager.getState('api.endpoints')?.length || 0,
                versions: StateManager.getState('api.versions')?.length || 0,
                currentVersion: StateManager.getState('api.currentVersion'),
                schema: !!StateManager.getState('api.schema')
            });

        } catch (error) {
            console.error('üí• Failed to initialize API System:', error);
            ErrorManager.handleError(error, 'System Initialization');
            showInitializationError(error);
        }
    }

    // Wait for required modules to be available
    async function waitForModules(moduleNames, timeout = 5000) {
        console.log('‚è≥ Waiting for modules:', moduleNames);
        const startTime = Date.now();

        while (Date.now() - startTime < timeout) {
            const availableModules = moduleNames.filter(name => typeof window[name] !== 'undefined');
            const missingModules = moduleNames.filter(name => typeof window[name] === 'undefined');

            console.log('üì¶ Module status:', {
                available: availableModules,
                missing: missingModules,
                elapsed: Date.now() - startTime + 'ms'
            });

            if (missingModules.length === 0) {
                console.log('‚úÖ All required modules are available!');
                return;
            }

            await new Promise(resolve => setTimeout(resolve, 100));
        }

        const missing = moduleNames.filter(name => typeof window[name] === 'undefined');
        console.error('‚ùå Timeout waiting for modules:', missing);
        throw new Error(`Required modules not available after ${timeout}ms: ${missing.join(', ')}`);
    }

    // Setup final UI state
    function setupFinalUI() {
        console.log('üéØ Setting up final UI state...');

        const endpoints = StateManager.getState('api.endpoints') || [];
        const versions = StateManager.getState('api.versions') || [];
        const currentVersion = StateManager.getState('api.currentVersion');

        console.log('üìä Final UI Data:', {
            endpoints: endpoints.length,
            versions: versions.length,
            currentVersion: currentVersion
        });

        // Update version selector
        const versionSelect = document.getElementById('version-select');
        if (versionSelect && versions.length > 0) {
            console.log('üîÑ Updating version selector with', versions.length, 'versions');
            versionSelect.innerHTML = versions.map(version => {
                const config = version.config || {};
                const title = config.title || 'API';
                const versionText = config.version || 'v1';
                const status = config.status ? ` (${config.status})` : '';
                const displayText = `${title} ${versionText}${status}`;

                return `<option value="${version.version}" ${version.version === currentVersion ? 'selected' : ''}>
                    ${displayText}
                </option>`;
            }).join('');
        } else {
            console.warn('‚ö†Ô∏è Version selector not found or no versions available');
        }

        // Update endpoint statistics
        updateStatistics(endpoints);

        if (endpoints.length > 0) {
            // Show filters section if we have endpoints
            const filtersSection = document.getElementById('api-filters');
            if (filtersSection) {
                filtersSection.style.display = 'block';
                console.log('‚úÖ Filters section shown');
            } else {
                console.warn('‚ö†Ô∏è Filters section not found');
            }

            // Update statistics
            EventBus.emit(APIEvents.UI.TAB_CHANGED, {
                tab: StateManager.getState('ui.currentTab'),
                endpointCount: endpoints.length
            });
        } else {
            console.warn('‚ö†Ô∏è No endpoints found - filters hidden');
        }
    }

    // Update statistics display
    function updateStatistics(endpoints) {
        console.log('üìà Updating statistics for', endpoints.length, 'endpoints');

        // Count statistics
        const stats = {
            totalEndpoints: endpoints.length,
            uniquePaths: new Set(endpoints.map(e => e.path)).size,
            authRequired: endpoints.filter(e => e.auth?.required).length,
            totalTags: new Set(endpoints.flatMap(e => e.tags || [])).size
        };

        console.log('üìä Calculated stats:', stats);

        // Update DOM elements
        const updates = [
            { id: 'api-endpoints-count', value: stats.totalEndpoints },
            { id: 'stats-unique-paths', value: stats.uniquePaths },
            { id: 'stats-auth-required', value: stats.authRequired },
            { id: 'stats-total-tags', value: stats.totalTags },
            { id: 'filtered-count', value: stats.totalEndpoints },
            { id: 'total-count', value: stats.totalEndpoints }
        ];

        updates.forEach(({ id, value }) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
                console.log(`‚úÖ Updated ${id}: ${value}`);
            } else {
                console.warn(`‚ö†Ô∏è Element not found: ${id}`);
            }
        });
    }

    // Show initialization error
    function showInitializationError(error) {
        const container = document.getElementById('main-content');
        if (container) {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <h4><i class="ri-error-warning-line"></i> Initialization Failed</h4>
                    <p>The API documentation system failed to initialize:</p>
                    <pre>${error.message}</pre>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="window.location.reload()">
                            <i class="ri-refresh-line"></i> Retry
                        </button>
                    </div>
                </div>
            `;
        }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        setTimeout(initializeApp, 0);
    }

    // Global utilities
    window.refreshAPIData = () => {
        if (typeof APIDataManager !== 'undefined' && APIDataManager.refresh) {
            return APIDataManager.refresh();
        }
    };

    window.initializeAPISystem = initializeApp;

{{end}}
