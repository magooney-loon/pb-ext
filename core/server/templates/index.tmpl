<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>pb-ext Dashboard</title>
    <link rel="shortcut icon" type="image/png" href="../_/images/favicon/favicon.png">
    <script>
        // Preserve hash on page refresh
        document.addEventListener('DOMContentLoaded', function() {
            // Store current hash in localStorage
            const currentHash = window.location.hash;
            if (currentHash) {
                localStorage.setItem('lastActiveTab', currentHash);
            }
        });

        // When page is about to refresh, make sure we keep the hash
        window.onbeforeunload = function() {
            const currentHash = window.location.hash;
            if (currentHash) {
                localStorage.setItem('lastActiveTab', currentHash);
            }
        };
    </script>
</head>
<body>
    <div id="app">
        <div class="app-layout">
            <aside class="app-sidebar">
                <a href="{{.PBAdminURL}}" class="logo logo-sm"><img src="{{.PBAdminURL}}/images/logo.svg" alt="PocketBase logo" width="40" height="40"></a>
                <nav class="main-menu">
                    <a href="#health" class="menu-item health-tab" aria-label="Health" title="Health"><i class="ri-heart-pulse-line"></i></a>
                    <a href="#analytics" class="menu-item analytics-tab" aria-label="Analytics" title="Analytics"><i class="ri-bar-chart-line"></i></a>
                    <a href="#api" class="menu-item api-tab" aria-label="API" title="API"><i class="ri-code-s-slash-line"></i></a>
                    <a href="#cron" class="menu-item cron-tab" aria-label="Cron Jobs" title="Cron Jobs"><i class="ri-time-line"></i></a>
                    <a href="#rules" class="menu-item rules-tab" aria-label="Rules" title="Rules"><i class="ri-lock-line"></i></a>
                </nav>
                <div onclick="openDebugAPI(event)" target="_blank" class="menu-item thumb thumb-circle link-hint" aria-label="Debug" title="Debug AST"><i class="ri-bug-line"></i></div>
            </aside>
            <div class="app-body" id="content" style="opacity: 0;">
                <!-- Health Section -->
                <div id="health-section" class="section-content">
                    <main class="page-content">
                        <div class="dashboard-wrapper">
                            {{template "header" .}}

                            <!-- Critical System Metrics -->
                            {{template "critical_metrics" .}}

                            <!-- Detail panels in a row -->
                            <div class="panels-grid">
                                {{template "cpu_details" .}}
                                {{template "memory_details" .}}
                            </div>
                        </div>
                    </main>
                </div>

                <!-- Analytics Section -->
                <div id="analytics-section" class="section-content" style="display: none;">
                    <main class="page-content">
                        <div class="dashboard-wrapper">
                            {{template "header" .}}

                            <!-- Visitor Analytics -->
                            {{template "visitor_analytics" .}}

                            <!-- Network Section -->
                            <div class="panels-grid">
                                {{template "network_details" .}}
                            </div>
                        </div>
                    </main>
                </div>

                <!-- API Section -->
                <div id="api-section" class="section-content" style="display: none;">
                    <main class="page-content">
                        <div class="dashboard-wrapper">
                            {{template "header" .}}

                            <!-- API Documentation -->
                            {{template "api_details" .}}
                        </div>
                    </main>
                </div>

                <!-- Cron Jobs Section -->
                <div id="cron-section" class="section-content" style="display: none;">
                    <main class="page-content">
                        <div class="dashboard-wrapper">
                            {{template "header" .}}

                            <!-- Cron Jobs Management -->
                            {{template "cron_jobs" .}}
                        </div>
                    </main>
                </div>

                <!-- Rules Section -->
                <div id="rules-section" class="section-content" style="display: none;">
                    <main class="page-content">
                        <div class="dashboard-wrapper">
                            {{template "header" .}}

                            <!-- API Rules Overview -->
                            {{template "rules" .}}
                        </div>
                    </main>
                </div>

            </div>

        </div>

    </div>


    {{template "scripts"}}
    <script>
        // Restore previous active tab
        (function() {
            const lastActiveTab = localStorage.getItem('lastActiveTab');
            if (lastActiveTab && !window.location.hash) {
                window.location.hash = lastActiveTab;
            }
        })();

        // Piggyback PocketBase CSS
        (async function() {
            try {
                // Try to fetch PocketBase admin UI styles
                const response = await fetch('{{.PBAdminURL}}');
                if (response.ok) {
                    const text = await response.text();
                    const parser = new DOMParser();
                    const pbDOM = parser.parseFromString(text, 'text/html');

                    // Get all CSS links from PocketBase admin UI
                    const cssLinks = pbDOM.querySelectorAll('link[rel="stylesheet"]');
                    if (cssLinks.length > 0) {
                        // Add PocketBase CSS to our page
                        for (let link of cssLinks) {
                            const clonedLink = document.createElement('link');
                            clonedLink.rel = 'stylesheet';
                            clonedLink.href = link.href;
                            document.head.appendChild(clonedLink);
                        }

                        // Add a class to body to apply PocketBase styled versions
                        document.body.classList.add('pb-styled');

                        console.log('Successfully piggybacked PocketBase CSS');
                    }

                    // Also get Remix icons if available
                    const remixLinks = pbDOM.querySelectorAll('link[href*="remixicon"]');
                    if (remixLinks.length > 0) {
                        for (let link of remixLinks) {
                            const clonedLink = document.createElement('link');
                            clonedLink.rel = 'stylesheet';
                            clonedLink.href = link.href;
                            document.head.appendChild(clonedLink);
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to piggyback PocketBase CSS:', error);
            }
        })();
    </script>

    <script>
        async function openDebugAPI(event) {
            event.preventDefault();

            const possibleTokenKeys = [
                '__pb_superuser_auth__',
            ];

            let authToken = null;
            for (const key of possibleTokenKeys) {
                const tokenData = localStorage.getItem(key);
                if (tokenData) {
                    try {
                        const parsed = JSON.parse(tokenData);
                        authToken = parsed.token || tokenData;
                        break;
                    } catch {
                        authToken = tokenData;
                        break;
                    }
                }
            }

            if (!authToken) {
                alert('No superuser auth token found in localStorage');
                return;
            }

            try {
                const response = await fetch('http://127.0.0.1:8090/api/docs/debug/ast', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + authToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const newWindow = window.open('', '_blank');

                    // Create HTML structure safely
                    newWindow.document.title = 'Debug AST Results';

                    // Add styles
                    const style = newWindow.document.createElement('style');
                    style.textContent = 'body { font-family: monospace; background: #1e1e1e; color: #d4d4d4; padding: 20px; } pre { white-space: pre-wrap; word-wrap: break-word; }';
                    newWindow.document.head.appendChild(style);

                    // Add content
                    const pre = newWindow.document.createElement('pre');
                    pre.textContent = JSON.stringify(data, null, 2);
                    newWindow.document.body.appendChild(pre);
                } else {
                    const errorText = await response.text();
                    alert('Debug API failed: ' + response.status + ' - ' + errorText);
                }
            } catch (error) {
                console.error('Error calling debug API:', error);
                alert('Error calling debug API: ' + error.message);
            }
        }
    </script>

</body>
</html>
